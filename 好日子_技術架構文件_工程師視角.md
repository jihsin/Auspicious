# 好日子 App — 技術架構與開發規格書

> **文件版本：** v1.0  
> **撰寫日期：** 2026-02-04  
> **撰寫人：** 資深 Apps 開發工程師  
> **文件性質：** 系統架構設計與技術規格文件

---

## 一、系統架構總覽

### 1.1 架構設計原則

| 原則 | 說明 |
|------|------|
| **離線優先** | 歷史統計數據為靜態資料，應預先計算並快取至客戶端，最大化離線可用性 |
| **計算前置** | 所有歷史統計在後端預先運算完畢，API 僅提供查詢，不做即時運算 |
| **漸進擴展** | 架構設計需支援從單站 → 全台 700+ 站的平滑擴展 |
| **數據分層** | 原始數據、統計快照、API 回應三層分離，便於獨立更新與維護 |

### 1.2 高階架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────┐     │
│  │  React Web   │  │  iOS App     │  │  Android App       │     │
│  │  (PWA-ready) │  │  (React      │  │  (React Native)    │     │
│  │              │  │   Native)    │  │                    │     │
│  └──────┬───────┘  └──────┬───────┘  └─────────┬──────────┘     │
│         │                 │                     │                │
│         └─────────────────┼─────────────────────┘                │
│                           │                                      │
│                    Local Cache (SQLite / AsyncStorage)            │
└───────────────────────────┼──────────────────────────────────────┘
                            │ HTTPS / REST API
┌───────────────────────────┼──────────────────────────────────────┐
│                     API Gateway Layer                             │
│  ┌────────────────────────┴─────────────────────────────────┐    │
│  │              Nginx Reverse Proxy + Rate Limiting           │    │
│  │              + CloudFlare CDN (靜態資源 + API Cache)       │    │
│  └────────────────────────┬─────────────────────────────────┘    │
└───────────────────────────┼──────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────────┐
│                    Application Layer                              │
│  ┌────────────────────────┴─────────────────────────────────┐    │
│  │                    FastAPI (Python)                        │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌──────────────────┐    │    │
│  │  │ 歷史查詢 API│ │ 節氣分析 API│ │ 好日子推薦 API   │    │    │
│  │  └─────────────┘ └─────────────┘ └──────────────────┘    │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │              Celery Task Queue (Redis)                     │    │
│  │  ┌────────────────┐  ┌──────────────────────────┐         │    │
│  │  │ 每日數據更新   │  │ 統計快照重新計算          │         │    │
│  │  └────────────────┘  └──────────────────────────┘         │    │
│  └──────────────────────────────────────────────────────────┘    │
└───────────────────────────┬──────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────────┐
│                      Data Layer                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────┐     │
│  │ PostgreSQL   │  │ Redis        │  │ Object Storage     │     │
│  │ (主資料庫)   │  │ (快取+隊列) │  │ (S3/GCS 原始CSV)  │     │
│  └──────────────┘  └──────────────┘  └────────────────────┘     │
└──────────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────────┐
│                 Data Pipeline Layer                               │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │              Python ETL Pipeline                           │    │
│  │  ┌──────────┐  ┌───────────┐  ┌───────────────────┐      │    │
│  │  │ CWA API  │  │ GitHub    │  │ CODiS 歷史典藏    │      │    │
│  │  │ 即時資料 │  │ 開源資料庫│  │ 深度歷史數據      │      │    │
│  │  └──────────┘  └───────────┘  └───────────────────┘      │    │
│  └──────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
```

---

## 二、數據層設計

### 2.1 數據來源與擷取策略

#### 2.1.1 主要數據源

**數據源一：GitHub 開源歷史資料庫（Raingel/historical_weather）**

- 用途：Phase 1 主要數據來源，快速取得完整歷史數據
- 位址：`https://github.com/Raingel/historical_weather`
- 格式：CSV，按站號/年份分檔
- 更新頻率：每日自動更新（GitHub Actions）
- 優點：資料已整理、含農業氣象站、免 API Key
- 擷取方式：`git clone` 或直接下載 CSV

**數據源二：CWA 氣象署開放資料 API**

- 用途：Phase 2 起作為即時數據更新來源
- 位址：`https://opendata.cwa.gov.tw`
- 認證：需註冊取得 API Key（免費）
- 格式：JSON / XML
- 文件：`https://opendata.cwa.gov.tw/dist/opendata-swagger.html`
- 限制：每日呼叫次數上限（需確認最新限額）

**數據源三：CODiS 氣候觀測資料查詢服務**

- 用途：補充更古老的歷史典藏資料（日據時期等）
- 位址：`https://codis.cwa.gov.tw`
- 格式：Web 查詢 + CSV 下載
- 適用場景：需要 1950 年前的深度歷史資料時

**數據源四：農曆與節氣資料**

- 二十四節氣日期計算：使用天文演算法（基於太陽黃經角度）或 CWA 天文資料 API
- 農曆轉換：使用開源套件如 `lunardate`（Python）或 `chinese-calendar`
- 農諺資料庫：自建，來源為公共領域傳統諺語，人工整理

#### 2.1.2 站號清單（Phase 1-2 重點站）

| 站號 | 站名 | 緯度 | 經度 | 數據起始年 |
|------|------|------|------|-----------|
| 466920 | 臺北 | 25.0376 | 121.5148 | 1896 |
| 467490 | 臺中 | 24.1457 | 120.6842 | 1896 |
| 467410 | 臺南 | 22.9933 | 120.2046 | 1897 |
| 467440 | 高雄 | 22.5659 | 120.3151 | 1932 |
| 466990 | 花蓮 | 23.9752 | 121.6134 | 1910 |
| 467660 | 臺東 | 22.7522 | 121.1546 | 1901 |

完整站號清單參考：`https://github.com/Raingel/weather_station_list`

### 2.2 資料庫設計

#### 2.2.1 資料庫選型

| 環境 | 資料庫 | 理由 |
|------|--------|------|
| 開發/MVP | SQLite | 零配置、嵌入式、足夠 MVP 需求 |
| 正式環境 | PostgreSQL 16+ | 強大的時間序列查詢、JSON 支援、穩定可靠 |
| 快取層 | Redis 7+ | API 回應快取、Celery 任務隊列 |
| 客戶端 | SQLite（App 內） | 離線快取統計快照 |

#### 2.2.2 核心資料表設計（PostgreSQL）

```sql
-- ===== 原始觀測數據 =====
CREATE TABLE raw_observations (
    id              BIGSERIAL PRIMARY KEY,
    station_id      VARCHAR(10) NOT NULL,
    observed_date   DATE NOT NULL,
    temperature_avg DECIMAL(5,2),        -- 日均溫 (°C)
    temperature_max DECIMAL(5,2),        -- 日最高溫
    temperature_min DECIMAL(5,2),        -- 日最低溫
    precipitation   DECIMAL(8,2),        -- 日降水量 (mm)
    humidity_avg    DECIMAL(5,2),        -- 平均相對溼度 (%)
    wind_speed_avg  DECIMAL(5,2),        -- 平均風速 (m/s)
    wind_gust_max   DECIMAL(5,2),        -- 最大瞬間風速
    sunshine_hours  DECIMAL(5,2),        -- 日照時數
    weather_code    VARCHAR(20),         -- 天氣現象代碼
    air_pressure    DECIMAL(7,2),        -- 測站氣壓 (hPa)
    data_source     VARCHAR(20) NOT NULL, -- 'github' / 'cwa_api' / 'codis'
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE (station_id, observed_date)
);

-- 複合索引：按站號+月日查詢（核心查詢路徑）
CREATE INDEX idx_obs_station_monthday 
    ON raw_observations (station_id, EXTRACT(MONTH FROM observed_date), EXTRACT(DAY FROM observed_date));

CREATE INDEX idx_obs_station_date 
    ON raw_observations (station_id, observed_date);


-- ===== 統計快照（預計算結果）=====
CREATE TABLE daily_statistics (
    id              BIGSERIAL PRIMARY KEY,
    station_id      VARCHAR(10) NOT NULL,
    month_day       VARCHAR(5) NOT NULL,   -- '02-04' 格式
    years_analyzed  INTEGER NOT NULL,
    start_year      INTEGER NOT NULL,
    end_year        INTEGER NOT NULL,
    
    -- 溫度統計
    temp_avg_mean       DECIMAL(5,2),
    temp_avg_median     DECIMAL(5,2),
    temp_avg_stddev     DECIMAL(5,2),
    temp_max_historical DECIMAL(5,2),
    temp_min_historical DECIMAL(5,2),
    temp_max_mean       DECIMAL(5,2),
    temp_min_mean       DECIMAL(5,2),
    
    -- 降水統計
    precip_probability  DECIMAL(5,4),       -- 0.0000 ~ 1.0000
    precip_avg_when_rain DECIMAL(8,2),      -- 有雨時平均降水量
    precip_heavy_prob   DECIMAL(5,4),       -- 大雨(>50mm)概率
    
    -- 天氣傾向
    tendency_sunny      DECIMAL(5,4),
    tendency_cloudy     DECIMAL(5,4),
    tendency_rainy      DECIMAL(5,4),
    tendency_stormy     DECIMAL(5,4),
    
    -- 其他統計
    humidity_avg_mean   DECIMAL(5,2),
    wind_speed_avg_mean DECIMAL(5,2),
    sunshine_hours_mean DECIMAL(5,2),
    
    -- 趨勢（近10年 vs 全歷史的差異）
    temp_trend_10yr     DECIMAL(5,2),       -- 正值=近年偏暖
    precip_trend_10yr   DECIMAL(5,2),       -- 正值=近年偏濕
    
    -- 元數據
    computed_at     TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE (station_id, month_day)
);


-- ===== 觀測站基本資料 =====
CREATE TABLE stations (
    station_id      VARCHAR(10) PRIMARY KEY,
    station_name    VARCHAR(50) NOT NULL,
    station_name_en VARCHAR(50),
    latitude        DECIMAL(8,6),
    longitude       DECIMAL(9,6),
    altitude        DECIMAL(7,2),         -- 海拔(m)
    city            VARCHAR(20),          -- 所在縣市
    data_start_year INTEGER,              -- 數據起始年份
    station_type    VARCHAR(20),          -- 'cwb_main' / 'cwb_auto' / 'agri'
    is_active       BOOLEAN DEFAULT TRUE
);


-- ===== 節氣資料 =====
CREATE TABLE solar_terms (
    id              SERIAL PRIMARY KEY,
    year            INTEGER NOT NULL,
    term_index      SMALLINT NOT NULL,    -- 1~24
    term_name       VARCHAR(10) NOT NULL, -- '立春'、'雨水' 等
    term_date       DATE NOT NULL,
    solar_longitude DECIMAL(6,3),         -- 太陽黃經角度
    lunar_month     SMALLINT,             -- 農曆月份
    lunar_day       SMALLINT,             -- 農曆日
    
    UNIQUE (year, term_index)
);


-- ===== 農諺資料庫 =====
CREATE TABLE proverbs (
    id              SERIAL PRIMARY KEY,
    proverb_text    TEXT NOT NULL,         -- 原文
    proverb_meaning TEXT,                  -- 白話解釋
    related_terms   VARCHAR(50)[],         -- 相關節氣
    region          VARCHAR(20),           -- 適用地區 ('全台' / '北部' / '中南部')
    category        VARCHAR(20),           -- 'precipitation' / 'temperature' / 'agriculture'
    verification_rate DECIMAL(5,4),        -- 歷史驗證正確率
    sample_years    INTEGER,              -- 驗證樣本年數
    is_tw_localized BOOLEAN DEFAULT FALSE, -- 是否為台灣在地化版本
    notes           TEXT
);


-- ===== 節氣天氣統計（交叉分析用）=====
CREATE TABLE solar_term_statistics (
    id              BIGSERIAL PRIMARY KEY,
    station_id      VARCHAR(10) NOT NULL,
    term_name       VARCHAR(10) NOT NULL,
    years_analyzed  INTEGER NOT NULL,
    
    temp_avg_mean       DECIMAL(5,2),
    precip_probability  DECIMAL(5,4),
    precip_avg          DECIMAL(8,2),
    
    -- 節氣適用性評估
    tw_applicability    VARCHAR(10),        -- 'high' / 'medium' / 'low' / 'not_applicable'
    tw_deviation_note   TEXT,               -- 與原始定義的偏差說明
    
    computed_at     TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE (station_id, term_name)
);
```

### 2.3 數據 ETL Pipeline

#### 2.3.1 數據擷取流程

```python
# Pipeline 概念流程（非完整程式碼）

# Step 1: 從 GitHub 下載歷史資料
def fetch_github_data(station_id: str) -> list[pd.DataFrame]:
    """
    下載 Raingel/historical_weather 的 CSV 檔案
    每個站每年一個檔案，合併為單一 DataFrame
    """
    base_url = f"https://raw.githubusercontent.com/Raingel/historical_weather/master/data/{station_id}"
    # 遍歷年份、下載、合併
    ...

# Step 2: 數據清洗
def clean_data(df: pd.DataFrame) -> pd.DataFrame:
    """
    - 處理缺失值（NaN、-9999 等標記）
    - 統一欄位名稱與單位
    - 過濾異常值（如溫度 > 50°C）
    - 日期格式標準化
    """
    ...

# Step 3: 寫入資料庫
def load_to_database(df: pd.DataFrame, station_id: str):
    """
    使用 UPSERT (INSERT ON CONFLICT UPDATE) 寫入 PostgreSQL
    確保重複執行不會產生重複資料
    """
    ...

# Step 4: 計算統計快照
def compute_daily_statistics(station_id: str):
    """
    對 366 天（含 2/29）每一天進行統計計算
    使用 ±3 日滑動視窗平滑
    """
    ...

# Step 5: 計算節氣交叉統計
def compute_solar_term_statistics(station_id: str):
    """
    對每個節氣日計算天氣統計
    並評估台灣適用性
    """
    ...
```

#### 2.3.2 滑動視窗平滑演算法

為避免單一日期數據量過少造成統計偏差，採用 ±N 日的滑動視窗：

```python
def get_smoothed_data(station_id: str, month: int, day: int, 
                       window: int = 3, min_years: int = 20) -> pd.DataFrame:
    """
    取得以目標日期為中心、前後各 window 天的所有歷史數據。
    例如查詢 2月4日，window=3 時會取 2/1 ~ 2/7 的所有年份數據。
    
    這樣即使某些年份的 2/4 數據缺失，仍有鄰近日期的數據可參考。
    """
    target_doy = date(2000, month, day).timetuple().tm_yday  # day of year
    doy_range = range(target_doy - window, target_doy + window + 1)
    
    # 查詢所有在 doy_range 內的歷史觀測數據
    # 返回時加入距離權重（中心日期權重最高）
    ...
```

---

## 三、API 層設計

### 3.1 技術選型

| 項目 | 選擇 | 理由 |
|------|------|------|
| 框架 | FastAPI (Python 3.11+) | 高效能非同步、自動生成 OpenAPI 文件、型別安全 |
| ORM | SQLAlchemy 2.0 + Alembic | 成熟穩定、支援非同步、遷移管理 |
| 序列化 | Pydantic v2 | FastAPI 原生整合、高效能驗證 |
| 任務隊列 | Celery + Redis | 非同步任務（數據更新、統計重算） |
| 部署 | Docker + Google Cloud Run | 自動擴縮、按請求計費、適合初期 |

### 3.2 API 端點設計

```yaml
# ===== 核心查詢 API =====

GET /api/v1/weather/daily/{station_id}/{month_day}
  # 查詢指定站的指定日期歷史統計
  # month_day 格式: "02-04"
  # 回傳: 完整 daily_statistics 記錄

GET /api/v1/weather/range/{station_id}?from=01-01&to=01-31
  # 查詢日期範圍的統計（月度概覽）

GET /api/v1/weather/today/{station_id}
  # 今日歷史統計 + 當前實際天氣對比

GET /api/v1/weather/compare/{station_id}/{month_day}
  # 歷史統計 vs 今年實際（偏差分析）


# ===== 節氣與農諺 API =====

GET /api/v1/solar-terms/{year}
  # 指定年份的 24 節氣日期列表

GET /api/v1/solar-terms/{year}/{term_name}
  # 指定節氣的天氣統計 + 農諺 + 台灣適用性

GET /api/v1/proverbs?term={term_name}&category={category}
  # 查詢相關農諺 + 歷史驗證率


# ===== 好日子推薦 API =====

GET /api/v1/good-days/{station_id}/{year}/{month}
  # 指定月份中歷史上天氣最好的日子排名

GET /api/v1/good-days/recommend?city={city}&type={wedding|outdoor|travel}&month={month}
  # 綜合推薦（天氣 + 農曆 + 節氣）


# ===== 觀測站 API =====

GET /api/v1/stations
  # 所有觀測站列表

GET /api/v1/stations/{station_id}
  # 觀測站詳細資訊

GET /api/v1/stations/nearest?lat={lat}&lon={lon}
  # 查詢最近的觀測站
```

### 3.3 API 回應格式範例

```json
// GET /api/v1/weather/daily/466920/02-04

{
  "status": "ok",
  "data": {
    "station": {
      "id": "466920",
      "name": "臺北",
      "city": "臺北市"
    },
    "date": "02-04",
    "analysis_period": {
      "years_analyzed": 49,
      "start_year": 1976,
      "end_year": 2025
    },
    "temperature": {
      "avg": {
        "mean": 16.2,
        "median": 15.8,
        "std_dev": 3.1,
        "percentile_25": 13.8,
        "percentile_75": 18.5
      },
      "daily_max": {
        "mean": 19.5,
        "historical_record": 27.2,
        "record_year": 2019
      },
      "daily_min": {
        "mean": 13.4,
        "historical_record": 6.1,
        "record_year": 2005
      },
      "trend_10yr": {
        "direction": "warming",
        "delta": 1.3,
        "note": "近10年均溫比全歷史高 1.3°C"
      }
    },
    "precipitation": {
      "probability": 0.35,
      "avg_amount_when_rain_mm": 8.7,
      "heavy_rain_probability": 0.04,
      "max_recorded_mm": 52.3,
      "max_recorded_year": 2011
    },
    "weather_tendency": {
      "sunny": 0.33,
      "cloudy": 0.32,
      "rainy": 0.31,
      "stormy": 0.04,
      "dominant": "sunny",
      "note": "晴/陰/雨幾乎各佔三分之一，典型的春季過渡天氣"
    },
    "humidity": {
      "mean": 78.5,
      "range": "70-88"
    },
    "wind": {
      "avg_speed_ms": 2.8,
      "dominant_direction": "NE"
    },
    "solar_term": {
      "name": "立春",
      "is_term_day": true,
      "term_meaning": "春季開始，萬物復甦",
      "tw_applicability": "medium",
      "tw_note": "台灣緯度較低，立春時體感溫度已比華北顯著偏暖"
    },
    "proverbs": [
      {
        "text": "立春落雨透清明",
        "meaning": "立春當天若下雨，到清明節都會多雨",
        "verification_rate": 0.42,
        "sample_years": 30
      }
    ]
  },
  "meta": {
    "computed_at": "2026-02-01T00:00:00Z",
    "data_sources": ["github_raingel", "cwa_api"],
    "smoothing_window": 3
  }
}
```

### 3.4 快取策略

```
┌──────────────────────────────────────────────┐
│              快取分層策略                       │
│                                                │
│  L1: CDN (CloudFlare)                          │
│  ├─ 統計快照 API: TTL = 24hr                   │
│  ├─ 節氣資料 API: TTL = 7 days                 │
│  └─ 觀測站列表: TTL = 30 days                  │
│                                                │
│  L2: Redis (Application Cache)                 │
│  ├─ 今日 vs 歷史比對: TTL = 1hr                │
│  ├─ 好日子推薦結果: TTL = 24hr                 │
│  └─ 熱門查詢結果: TTL = 6hr                    │
│                                                │
│  L3: PostgreSQL (Materialized Views)           │
│  ├─ daily_statistics 表（預計算）               │
│  └─ solar_term_statistics 表（預計算）          │
│                                                │
│  L4: Client (SQLite / AsyncStorage)            │
│  ├─ 已查詢過的日期統計: 本地永久快取            │
│  └─ 節氣列表: 本地快取至年底                    │
└──────────────────────────────────────────────┘
```

---

## 四、前端/App 層設計

### 4.1 技術選型

| 項目 | Phase 1 (Web) | Phase 2 (App) |
|------|---------------|---------------|
| 框架 | React 18 + Next.js 14 | React Native 0.73+ |
| 狀態管理 | Zustand | Zustand |
| UI 組件 | Tailwind CSS + shadcn/ui | React Native Paper |
| 圖表 | Recharts | react-native-chart-kit 或 Victory |
| 地圖 | Leaflet / Mapbox | react-native-maps |
| 離線存儲 | IndexedDB (Dexie.js) | SQLite (expo-sqlite) |
| 動畫 | Framer Motion | Reanimated 3 |

### 4.2 核心頁面設計

**首頁（Today View）**
- 上方：今日日期 + 節氣標示（如「立春」）
- 中間：歷史溫度統計視覺化（鐘形曲線 + 今日實際標記）
- 下方：降水概率圓餅圖 + 天氣傾向分布 + 農諺卡片

**日期查詢頁**
- 日曆選擇器（標示節氣日）
- 查詢結果頁面：完整統計儀表板

**好日子推薦頁**
- 選擇月份 + 目的（婚禮/戶外/旅遊）
- 顯示該月每日的「好天氣指數」排名

**節氣探索頁**
- 24 節氣時間軸
- 每個節氣的天氣統計 + 農諺 + 台灣適用性

**觀測站地圖頁**
- 台灣地圖上顯示所有可用觀測站
- 點擊選擇後切換查詢站

### 4.3 離線優先策略

```
使用者首次開啟 App
    │
    ▼
下載當前站的 366 天統計快照（約 200KB JSON）
    │
    ▼
存入本地 SQLite / IndexedDB
    │
    ▼
後續查詢優先從本地讀取
    │
    ├─ 本地有 → 直接顯示（< 50ms）
    │
    └─ 本地無 → API 查詢 → 寫入本地 → 顯示
```

---

## 五、部署架構

### 5.1 Phase 1 — MVP 部署（簡化版）

```
GitHub Actions (CI/CD)
    │
    ▼
Docker Image → Google Artifact Registry
    │
    ▼
Google Cloud Run (API 服務)
    │
    ├─ Cloud SQL for PostgreSQL（資料庫）
    ├─ Memorystore for Redis（快取）
    └─ Cloud Storage（原始 CSV 備份）
    
    ＋
    
Vercel（React 前端）
    └─ 或直接用 Cloud Run 提供靜態檔案
```

### 5.2 Phase 2-3 — 完整部署

```
GitHub Actions (CI/CD)
    │
    ├── API 服務 → Cloud Run (auto-scaling 0-10)
    ├── Celery Worker → Cloud Run Jobs
    ├── 前端 → Vercel (CDN)
    ├── App → App Store / Google Play
    │
    ├── 資料庫 → Cloud SQL (PostgreSQL)
    ├── 快取 → Memorystore (Redis)
    ├── 物件儲存 → Cloud Storage
    └── 監控 → Cloud Monitoring + Sentry
```

### 5.3 CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml 概念

name: Deploy Pipeline

on:
  push:
    branches: [main]

jobs:
  test:
    # 執行單元測試 + 整合測試
    
  build:
    # 建構 Docker Image
    # 推送至 Artifact Registry
    
  deploy-staging:
    # 部署至 Staging 環境
    # 執行 E2E 測試
    
  deploy-production:
    # 需人工核准
    # 部署至 Production
    # 執行 Smoke Test
    
  data-pipeline:
    # 排程：每日凌晨 2:00
    # 從 CWA API 抓取前一日數據
    # 更新 raw_observations
    # 重新計算受影響的 daily_statistics
```

---

## 六、統計分析引擎詳細設計

### 6.1 核心分析函式

```python
# analytics/engine.py

import pandas as pd
import numpy as np
from datetime import date
from typing import Optional

class HistoricalWeatherAnalyzer:
    """
    歷史天氣統計分析引擎。
    負責從原始觀測數據計算統計快照。
    """
    
    def __init__(self, db_session, station_id: str):
        self.db = db_session
        self.station_id = station_id
    
    def compute_daily_stats(
        self, 
        month: int, 
        day: int, 
        window: int = 3,
        recent_years: int = 10
    ) -> dict:
        """
        計算指定日期的完整統計。
        
        Parameters:
            month: 月份 (1-12)
            day: 日 (1-31)
            window: 滑動視窗半徑（天數）
            recent_years: 近年趨勢計算的年數
            
        Returns:
            完整的統計快照 dict
        """
        
        # 1. 取得原始數據（含滑動視窗）
        raw_data = self._fetch_windowed_data(month, day, window)
        center_data = self._fetch_exact_date_data(month, day)
        
        # 2. 溫度統計
        temp_stats = self._compute_temperature_stats(raw_data, center_data, recent_years)
        
        # 3. 降水統計
        precip_stats = self._compute_precipitation_stats(center_data)
        
        # 4. 天氣傾向
        tendency = self._compute_weather_tendency(center_data)
        
        # 5. 其他氣象要素
        other_stats = self._compute_other_stats(raw_data)
        
        return {
            "temperature": temp_stats,
            "precipitation": precip_stats,
            "weather_tendency": tendency,
            "humidity": other_stats["humidity"],
            "wind": other_stats["wind"],
            "sunshine": other_stats["sunshine"],
            "years_analyzed": len(center_data),
            "start_year": int(center_data['year'].min()),
            "end_year": int(center_data['year'].max()),
        }
    
    def _compute_temperature_stats(self, data, center_data, recent_years):
        """溫度統計計算"""
        current_year = date.today().year
        recent_mask = center_data['year'] >= (current_year - recent_years)
        
        return {
            "avg": {
                "mean": round(data['temperature_avg'].mean(), 2),
                "median": round(data['temperature_avg'].median(), 2),
                "std_dev": round(data['temperature_avg'].std(), 2),
                "percentile_25": round(data['temperature_avg'].quantile(0.25), 2),
                "percentile_75": round(data['temperature_avg'].quantile(0.75), 2),
            },
            "daily_max": {
                "mean": round(data['temperature_max'].mean(), 2),
                "historical_record": round(data['temperature_max'].max(), 2),
                "record_year": int(data.loc[data['temperature_max'].idxmax(), 'year']),
            },
            "daily_min": {
                "mean": round(data['temperature_min'].mean(), 2),
                "historical_record": round(data['temperature_min'].min(), 2),
                "record_year": int(data.loc[data['temperature_min'].idxmin(), 'year']),
            },
            "trend_10yr": {
                "delta": round(
                    center_data[recent_mask]['temperature_avg'].mean() - 
                    center_data['temperature_avg'].mean(), 2
                ),
                "direction": "warming" if (
                    center_data[recent_mask]['temperature_avg'].mean() > 
                    center_data['temperature_avg'].mean()
                ) else "cooling",
            }
        }
    
    def _compute_precipitation_stats(self, data):
        """降水統計計算"""
        has_rain = data['precipitation'] > 0.1  # > 0.1mm 視為有雨
        heavy_rain = data['precipitation'] > 50  # > 50mm 視為大雨
        
        return {
            "probability": round(has_rain.mean(), 4),
            "avg_amount_when_rain_mm": round(
                data.loc[has_rain, 'precipitation'].mean(), 2
            ) if has_rain.any() else 0,
            "heavy_rain_probability": round(heavy_rain.mean(), 4),
            "max_recorded_mm": round(data['precipitation'].max(), 2),
            "max_recorded_year": int(
                data.loc[data['precipitation'].idxmax(), 'year']
            ),
        }
    
    def _compute_weather_tendency(self, data):
        """天氣類型傾向計算"""
        total = len(data)
        if total == 0:
            return {}
        
        # 基於降水量和日照時數分類
        sunny = ((data['precipitation'] < 0.1) & 
                 (data['sunshine_hours'] > 3)).sum() / total
        rainy = (data['precipitation'] >= 1.0).sum() / total
        stormy = (data['precipitation'] >= 50).sum() / total
        cloudy = 1.0 - sunny - rainy  # 剩餘歸類為陰天
        
        tendencies = {
            "sunny": round(max(sunny, 0), 4),
            "cloudy": round(max(cloudy, 0), 4),
            "rainy": round(rainy - stormy, 4),  # 雨但非暴雨
            "stormy": round(stormy, 4),
        }
        tendencies["dominant"] = max(tendencies, key=tendencies.get)
        
        return tendencies
```

### 6.2 農諺驗證引擎

```python
# analytics/proverb_verifier.py

class ProverbVerifier:
    """
    農諺歷史驗證引擎。
    以歷史氣象數據驗算傳統農諺的正確率。
    """
    
    def verify_lichun_rain_to_qingming(
        self, station_id: str, years: range
    ) -> dict:
        """
        驗證：「立春落雨透清明」
        規則：立春當天有雨 → 預測立春到清明期間多雨
        驗證方式：
          1. 找出所有立春有雨的年份
          2. 計算這些年份中，立春至清明的降水日數是否 > 歷史平均
        """
        results = []
        for year in years:
            lichun_date = self._get_solar_term_date(year, "立春")
            qingming_date = self._get_solar_term_date(year, "清明")
            
            lichun_rain = self._has_rain(station_id, lichun_date)
            period_rain_days = self._count_rain_days(
                station_id, lichun_date, qingming_date
            )
            avg_rain_days = self._get_avg_rain_days(
                station_id, lichun_date, qingming_date
            )
            
            if lichun_rain:
                # 立春有雨 → 預測多雨 → 驗證是否真的多雨
                correct = period_rain_days > avg_rain_days
                results.append({
                    "year": year,
                    "lichun_rain": True,
                    "prediction": "多雨",
                    "actual_rain_days": period_rain_days,
                    "avg_rain_days": avg_rain_days,
                    "correct": correct
                })
        
        verification_rate = sum(r["correct"] for r in results) / len(results)
        return {
            "proverb": "立春落雨透清明",
            "verification_rate": round(verification_rate, 4),
            "sample_size": len(results),
            "details": results
        }
```

---

## 七、安全性設計

### 7.1 API 安全

| 層級 | 措施 |
|------|------|
| 傳輸層 | HTTPS 強制、TLS 1.3 |
| 認證 | Phase 1 免認證（公開數據）；Phase 3 API Key（B2B） |
| 限流 | Nginx rate limiting：100 req/min per IP |
| 輸入驗證 | Pydantic 自動驗證所有輸入參數 |
| CORS | 白名單制，僅允許自有域名 |

### 7.2 數據安全

| 項目 | 措施 |
|------|------|
| 資料庫 | Cloud SQL 自動加密、每日備份 |
| 敏感設定 | 環境變數 + Secret Manager |
| 日誌 | 不記錄敏感資訊、保留 90 天 |

---

## 八、效能目標

| 指標 | 目標值 |
|------|--------|
| API 回應時間（統計查詢） | < 100ms（快取命中）/ < 500ms（快取未命中） |
| 前端首屏載入 | < 2 秒（LTE 網路） |
| 統計快照計算（全站 366 天） | < 5 分鐘 |
| 每日數據更新 Pipeline | < 10 分鐘 |
| 同時在線用戶承載 | 1,000+ concurrent（Phase 1） |
| App 大小 | < 30MB（不含離線數據） |
| 離線查詢速度 | < 50ms |

---

## 九、監控與維運

### 9.1 監控架構

```
Application Metrics
    ├── API 回應時間 (p50, p95, p99)
    ├── 錯誤率 (4xx, 5xx)
    ├── 每秒請求數 (RPS)
    └── 快取命中率

Infrastructure Metrics
    ├── CPU / Memory 使用率
    ├── 資料庫連線數
    ├── Redis 記憶體使用
    └── Cloud Run Instance 數量

Data Pipeline Metrics
    ├── ETL 執行狀態
    ├── 數據完整性檢查
    ├── 最新數據日期
    └── 統計快照更新時間

Alerting Rules
    ├── API 錯誤率 > 5%  → Slack 通知
    ├── 回應時間 p95 > 2s → Slack 通知
    ├── ETL 失敗           → 即時告警
    └── 資料庫空間 > 80%  → 提前預警
```

### 9.2 工具選擇

| 用途 | 工具 |
|------|------|
| APM | Sentry (錯誤追蹤 + 效能監控) |
| 基礎設施 | Google Cloud Monitoring |
| 日誌 | Google Cloud Logging |
| 告警 | Slack Webhook + PagerDuty（Phase 3） |
| Uptime | UptimeRobot（免費方案足夠） |

---

## 十、開發環境與工具鏈

### 10.1 開發環境

```
本地開發環境
    ├── Python 3.11+ (pyenv 管理)
    ├── Node.js 20 LTS (nvm 管理)
    ├── Docker Desktop
    ├── PostgreSQL 16 (Docker)
    ├── Redis 7 (Docker)
    └── VS Code + Cursor

套件管理
    ├── Python: Poetry (依賴管理 + 虛擬環境)
    ├── Node.js: pnpm
    └── Docker: docker-compose.yml
```

### 10.2 程式碼品質

| 工具 | 用途 |
|------|------|
| Ruff | Python linting + formatting |
| mypy | Python 型別檢查 |
| pytest | Python 單元/整合測試 |
| ESLint + Prettier | JS/TS 程式碼品質 |
| Vitest | 前端測試 |
| pre-commit | 提交前自動檢查 |

### 10.3 專案目錄結構

```
good-day/
├── backend/
│   ├── app/
│   │   ├── main.py              # FastAPI 入口
│   │   ├── config.py            # 設定管理
│   │   ├── models/              # SQLAlchemy Models
│   │   │   ├── observation.py
│   │   │   ├── statistics.py
│   │   │   ├── station.py
│   │   │   ├── solar_term.py
│   │   │   └── proverb.py
│   │   ├── schemas/             # Pydantic Schemas
│   │   │   ├── weather.py
│   │   │   └── solar_term.py
│   │   ├── api/                 # API Routes
│   │   │   ├── v1/
│   │   │   │   ├── weather.py
│   │   │   │   ├── solar_terms.py
│   │   │   │   ├── good_days.py
│   │   │   │   └── stations.py
│   │   │   └── deps.py          # 共用依賴
│   │   ├── analytics/           # 分析引擎
│   │   │   ├── engine.py
│   │   │   ├── proverb_verifier.py
│   │   │   └── solar_term_analyzer.py
│   │   └── tasks/               # Celery 非同步任務
│   │       ├── data_fetch.py
│   │       └── stats_compute.py
│   ├── migrations/              # Alembic 資料庫遷移
│   ├── tests/
│   ├── Dockerfile
│   └── pyproject.toml
│
├── data-pipeline/
│   ├── fetch_github.py          # 從 GitHub 下載歷史資料
│   ├── fetch_cwa_api.py         # 從 CWA API 抓取即時資料
│   ├── clean.py                 # 數據清洗
│   ├── load.py                  # 寫入資料庫
│   └── compute_snapshots.py     # 計算統計快照
│
├── frontend/
│   ├── src/
│   │   ├── app/                 # Next.js App Router
│   │   ├── components/
│   │   │   ├── charts/          # 圖表組件
│   │   │   ├── calendar/        # 日曆組件
│   │   │   └── ui/              # 通用 UI
│   │   ├── hooks/               # Custom Hooks
│   │   ├── lib/                 # 工具函式
│   │   └── store/               # Zustand Store
│   ├── public/
│   ├── next.config.js
│   └── package.json
│
├── mobile/                      # Phase 2
│   └── (React Native 專案)
│
├── docker-compose.yml
├── .github/
│   └── workflows/
│       ├── test.yml
│       ├── deploy.yml
│       └── data-pipeline.yml
└── README.md
```

---

## 十一、開發資源彙整

### 11.1 數據資源

| 資源 | URL | 用途 |
|------|-----|------|
| CWA 開放資料 | https://opendata.cwa.gov.tw | 即時 + 歷史氣象 API |
| CODiS | https://codis.cwa.gov.tw | 深度歷史氣候查詢 |
| GitHub 歷史資料庫 | https://github.com/Raingel/historical_weather | 整理好的歷史 CSV |
| 站號清單 | https://github.com/Raingel/weather_station_list | 觀測站對照表 |
| 政府開放資料 | https://data.gov.tw/dataset/9176 | 自動站逐時觀測 |

### 11.2 技術文件

| 文件 | URL |
|------|-----|
| FastAPI | https://fastapi.tiangolo.com |
| SQLAlchemy 2.0 | https://docs.sqlalchemy.org |
| React | https://react.dev |
| Next.js | https://nextjs.org/docs |
| React Native | https://reactnative.dev |
| Google Cloud Run | https://cloud.google.com/run/docs |

### 11.3 參考研究

- 林和駿，〈二十四節氣與台灣氣候之比較研究〉— 節氣台灣適用性分析
- 日本七十二候 — 本地化物候系統參考
- WeatherSpark (NASA MERRA-2) — 全球氣候基準線數據

---

> **本文件將隨開發進程持續更新。**  
> **下一步行動：建立開發環境、啟動 Phase 1 Sprint 1（數據擷取與清洗）。**
